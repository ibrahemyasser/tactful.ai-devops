name: Smoke Tests

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options: [dev, prod]
  workflow_call:
    inputs:
      environment:
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      # Dev: Get ALB directly
      - if: inputs.environment == 'dev'
        id: url-dev
        run: |
          aws eks update-kubeconfig --name tactful-voting-dev --region ${{ vars.AWS_REGION }}
          VOTE_ALB=$(kubectl get ingress vote-ingress -n voting-dev -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          RESULT_ALB=$(kubectl get ingress result-ingress -n voting-dev -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          echo "vote=http://$VOTE_ALB" >> $GITHUB_OUTPUT
          echo "result=http://$RESULT_ALB" >> $GITHUB_OUTPUT

      # Prod: Get ALB via SSM
      - if: inputs.environment == 'prod'
        id: url-prod
        run: |
          INSTANCE_ID=${{ secrets.PROD_SSM_INSTANCE_ID }}
          
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters commands="[
              'aws eks update-kubeconfig --name tactful-voting-prod --region ${{ vars.AWS_REGION }}',
              'echo VOTE_ALB=$(kubectl get ingress vote-ingress -n voting-prod -o jsonpath={.status.loadBalancer.ingress[0].hostname})',
              'echo RESULT_ALB=$(kubectl get ingress result-ingress -n voting-prod -o jsonpath={.status.loadBalancer.ingress[0].hostname})'
            ]" \
            --output text --query "Command.CommandId")
          
          aws ssm wait command-executed --command-id "$COMMAND_ID" --instance-id "$INSTANCE_ID"
          OUTPUT=$(aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "$INSTANCE_ID" --query "StandardOutputContent" --output text)
          VOTE_ALB=$(echo "$OUTPUT" | grep VOTE_ALB | cut -d= -f2)
          RESULT_ALB=$(echo "$OUTPUT" | grep RESULT_ALB | cut -d= -f2)
          
          echo "vote=https://$VOTE_ALB" >> $GITHUB_OUTPUT
          echo "result=https://$RESULT_ALB" >> $GITHUB_OUTPUT

      - id: url
        run: |
          if [ "${{ inputs.environment }}" = "dev" ]; then
            echo "vote=${{ steps.url-dev.outputs.vote }}" >> $GITHUB_OUTPUT
            echo "result=${{ steps.url-dev.outputs.result }}" >> $GITHUB_OUTPUT
          else
            echo "vote=${{ steps.url-prod.outputs.vote }}" >> $GITHUB_OUTPUT
            echo "result=${{ steps.url-prod.outputs.result }}" >> $GITHUB_OUTPUT
          fi
      - run: |
          for i in {1..10}; do
            curl -sf "${{ steps.url.outputs.vote }}" | grep -qi "cats\|dogs" && echo "✅ Vote OK" && break
            sleep 10
          done
      - run: |
          for i in {1..10}; do
            curl -sf "${{ steps.url.outputs.result }}" | grep -qi "result\|votes" && echo "✅ Result OK" && break
            sleep 10
          done
