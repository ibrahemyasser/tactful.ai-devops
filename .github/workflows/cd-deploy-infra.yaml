name: CD - Deploy Infrastructure (Terraform)

on:
  # Manual only - infrastructure changes are critical
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - dev
          - prod
      action:
        description: 'Action'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
      component:
        description: 'Component'
        required: true
        type: choice
        options:
          - all
          - github-oidc
          - vpc
          - secrets-manager
          - eks-cluster
      setup_cluster:
        description: 'Setup cluster after apply?'
        required: false
        type: boolean
        default: true

permissions:
  id-token: write
  contents: read

jobs:
  terraform-deploy:
    name: ${{ inputs.action }} - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      eks_applied: ${{ steps.check.outputs.eks_applied }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.0
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v0.93.9/terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt && chmod +x /usr/local/bin/terragrunt

      - name: Run Terraform
        id: terraform
        working-directory: terraform-infrastructure/environments/${{ inputs.environment }}
        run: |
          if [ "${{ inputs.component }}" = "all" ]; then
            terragrunt run --all ${{ inputs.action }} --non-interactive    
          else
            cd ${{ inputs.component }}
            terragrunt ${{ inputs.action }} --non-interactive
          fi

      - name: Check if EKS was applied
        id: check
        if: inputs.action == 'apply'
        run: |
          if [ "${{ inputs.component }}" = "all" ] || [ "${{ inputs.component }}" = "eks-cluster" ]; then
            echo "eks_applied=true" >> $GITHUB_OUTPUT
          else
            echo "eks_applied=false" >> $GITHUB_OUTPUT
          fi

  setup-cluster:
    needs: terraform-deploy
    if: |
      inputs.action == 'apply' && 
      inputs.setup_cluster == true && 
      needs.terraform-deploy.outputs.eks_applied == 'true'
    uses: ./.github/workflows/cd-setup-cluster.yaml
    secrets: inherit
    with:
      environment: ${{ inputs.environment }}
