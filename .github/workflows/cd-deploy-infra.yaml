name: CD - Deploy Infrastructure (Terraform)

on:
  # Manual only - infrastructure changes are critical
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - dev
          - prod
      action:
        description: 'Action'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
      component:
        description: 'Component'
        required: true
        type: choice
        options:
          - all
          - github-oidc
          - vpc
          - secrets-manager
          - eks-cluster
      setup_cluster:
        description: 'Setup cluster after apply?'
        required: false
        type: boolean
        default: true

permissions:
  id-token: write
  contents: read

jobs:
  cleanup-cluster:
    name: Cleanup Cluster Resources
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    if: inputs.action == 'destroy' && (inputs.component == 'all' || inputs.component == 'eks-cluster')
    
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Setup Helm
        uses: azure/setup-helm@v3

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name tactful-voting-${{ inputs.environment }} \
            --region ${{ vars.AWS_REGION }}

      - name: Delete Helm releases and Ingresses
        run: |
          echo "ðŸ—‘ï¸  Deleting Helm releases to remove Ingresses and trigger ALB cleanup..."
          
          # Delete app Helm release (contains Ingresses)
          helm list -n voting-${{ inputs.environment }} -q | xargs -r helm uninstall -n voting-${{ inputs.environment }} --wait || true
          
          # Delete any remaining infrastructure Helm releases
          helm list -n external-secrets -q | xargs -r helm uninstall -n external-secrets --wait || true
          helm list -n aws-load-balancer-controller -q | xargs -r helm uninstall -n aws-load-balancer-controller --wait || true
          
          echo "â³ Waiting for ALBs to be deleted (60 seconds)..."
          sleep 60
          
          # Force delete any remaining Ingress resources
          echo "ðŸ” Force deleting any remaining Ingress resources..."
          kubectl get ingress -A -o json | \
            jq -r '.items[] | "\(.metadata.namespace) \(.metadata.name)"' | \
            while read -r ns name; do
              echo "   Deleting ingress $name in namespace $ns"
              kubectl delete ingress "$name" -n "$ns" --wait=false --timeout=10s || true
            done
          
          # Delete LoadBalancer services
          echo "ðŸ” Deleting LoadBalancer services..."
          kubectl get svc -A -o json | \
            jq -r '.items[] | select(.spec.type=="LoadBalancer") | "\(.metadata.namespace) \(.metadata.name)"' | \
            while read -r ns name; do
              echo "   Deleting service $name in namespace $ns"
              kubectl delete svc "$name" -n "$ns" --wait=false --timeout=10s || true
            done
          
          echo "âœ… Cluster cleanup initiated"

  terraform-deploy:
    name: ${{ inputs.action }} - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    needs: [cleanup-cluster]
    if: always() && (needs.cleanup-cluster.result == 'success' || needs.cleanup-cluster.result == 'skipped')
    outputs:
      eks_applied: ${{ steps.check.outputs.eks_applied }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.0
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v0.93.9/terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt && chmod +x /usr/local/bin/terragrunt

      - name: Run Terraform
        id: terraform
        working-directory: terraform-infrastructure/environments/${{ inputs.environment }}
        run: |
          if [ "${{ inputs.component }}" = "all" ]; then
            terragrunt run --all ${{ inputs.action }} --non-interactive    
          else
            cd ${{ inputs.component }}
            terragrunt ${{ inputs.action }} --non-interactive
          fi

      - name: Check if EKS was applied
        id: check
        if: inputs.action == 'apply'
        run: |
          if [ "${{ inputs.component }}" = "all" ] || [ "${{ inputs.component }}" = "eks-cluster" ]; then
            echo "eks_applied=true" >> $GITHUB_OUTPUT
          else
            echo "eks_applied=false" >> $GITHUB_OUTPUT
          fi

  setup-cluster:
    needs: terraform-deploy
    if: |
      inputs.action == 'apply' && 
      inputs.setup_cluster == true && 
      needs.terraform-deploy.outputs.eks_applied == 'true'
    uses: ./.github/workflows/cd-setup-cluster.yaml
    secrets: inherit
    with:
      environment: ${{ inputs.environment }}
