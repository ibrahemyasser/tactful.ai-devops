name: CD - Setup EKS Cluster

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options: [dev, prod]

permissions:
  id-token: write
  contents: read

jobs:
  setup:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      # Dev: Direct access (public EKS endpoint)
      - if: inputs.environment == 'dev'
        run: |
          aws eks update-kubeconfig --name tactful-voting-dev --region ${{ vars.AWS_REGION }}
          kubectl cluster-info

      - uses: azure/setup-helm@v4
      # Dev: Direct kubectl/helm commands
      - if: inputs.environment == 'dev'
        run: |
          # Create StorageClass
          cat <<'EOT' | kubectl apply -f -
          apiVersion: storage.k8s.io/v1
          kind: StorageClass
          metadata:
            name: ebs-gp3
            annotations:
              storageclass.kubernetes.io/is-default-class: "true"
          provisioner: ebs.csi.aws.com
          parameters:
            type: gp3
            encrypted: "true"
          volumeBindingMode: WaitForFirstConsumer
          EOT
          
          # Add Helm repos
          helm repo add external-secrets https://charts.external-secrets.io
          helm repo add eks https://aws.github.io/eks-charts
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update
          
          local temp_crd_file="/tmp/external-secrets-crds.yaml"
          curl -sL https://raw.githubusercontent.com/external-secrets/external-secrets/v1.0.0/deploy/crds/bundle.yaml -o "$temp_crd_file"
          
          # Apply with server-side apply to handle large annotations
          if kubectl apply --server-side -f "$temp_crd_file" 2>&1 | tee /tmp/eso-crd-install.log; then
              echo "✅ External Secrets CRDs installed successfully"
          else
              echo "❌ Failed to install External Secrets CRDs"
              exit 1
          fi
          # Install cluster-level components
          helm upgrade --install external-secrets external-secrets/external-secrets -n external-secrets-system --create-namespace --wait
          helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller \
            -n kube-system \
            --set clusterName=tactful-voting-dev \
            --set region=${{ vars.AWS_REGION }} \
            --set vpcId=$(aws eks describe-cluster --name tactful-voting-dev --query 'cluster.resourcesVpcConfig.vpcId' --output text) \
            --wait
          
          # Install infrastructure (namespace, ServiceAccount, SecretStore)
          helm upgrade --install infrastructure helm-chart/infrastructure \
            -f helm-chart/infrastructure/values.yaml \
            -f helm-chart/infrastructure/values-dev.yaml \
            --wait
          
          # Install data stores
          helm upgrade --install postgresql helm-chart/postgresql -n voting-dev -f helm-chart/postgresql/values.yaml -f helm-chart/postgresql/values-dev.yaml --wait --timeout 10m
          helm upgrade --install redis helm-chart/redis -n voting-dev -f helm-chart/redis/values.yaml -f helm-chart/redis/values-dev.yaml --wait --timeout 10m

      # Prod: Use SSM to execute commands on bastion/worker instance
      - if: inputs.environment == 'prod'
        run: |
          INSTANCE_ID=${{ secrets.PROD_SSM_INSTANCE_ID }}
          
          # Create setup script
          cat > setup-prod.sh <<'SCRIPT'
          #!/bin/bash
          set -e
          
          # Configure kubectl
          aws eks update-kubeconfig --name tactful-voting-prod --region ${{ vars.AWS_REGION }}
          
          # Create StorageClass
          cat <<EOT | kubectl apply -f -
          apiVersion: storage.k8s.io/v1
          kind: StorageClass
          metadata:
            name: ebs-gp3
            annotations:
              storageclass.kubernetes.io/is-default-class: "true"
          provisioner: ebs.csi.aws.com
          parameters:
            type: gp3
            encrypted: "true"
          volumeBindingMode: WaitForFirstConsumer
          EOT
          
          # Add Helm repos
          helm repo add external-secrets https://charts.external-secrets.io
          helm repo add eks https://aws.github.io/eks-charts
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update
          
          # Install cluster-level components
          helm upgrade --install external-secrets external-secrets/external-secrets -n external-secrets-system --create-namespace --wait
          helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller -n kube-system --set clusterName=tactful-voting-prod --set region=${{ vars.AWS_REGION }} --set vpcId=\$(aws eks describe-cluster --name tactful-voting-prod --query 'cluster.resourcesVpcConfig.vpcId' --output text) --wait
          
          # Install infrastructure (namespace, ServiceAccount, SecretStore)
          helm upgrade --install infrastructure /tmp/helm-chart/infrastructure \
            -f /tmp/helm-chart/infrastructure/values.yaml \
            -f /tmp/helm-chart/infrastructure/values-prod.yaml \
            --wait
          
          # Install data stores
          helm upgrade --install postgresql /tmp/helm-chart/postgresql -n voting-prod -f /tmp/helm-chart/postgresql/values.yaml -f /tmp/helm-chart/postgresql/values-prod.yaml --wait --timeout 10m
          helm upgrade --install redis /tmp/helm-chart/redis -n voting-prod -f /tmp/helm-chart/redis/values.yaml -f /tmp/helm-chart/redis/values-prod.yaml --wait --timeout 10m
          
          echo "✅ Prod cluster setup complete"
          SCRIPT
          
          # Copy Helm charts to instance
          aws s3 cp helm-chart/ s3://tactful-voting-artifacts-${{ vars.AWS_REGION }}/helm-chart/ --recursive
          
          # Execute via SSM
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters commands="[
              'aws s3 cp s3://tactful-voting-artifacts-${{ vars.AWS_REGION }}/helm-chart/ /tmp/helm-chart/ --recursive',
              'cd /tmp',
              'bash /tmp/setup-prod.sh'
            ]" \
            --output text --query "Command.CommandId")
          
          # Wait for completion
          aws ssm wait command-executed --command-id "$COMMAND_ID" --instance-id "$INSTANCE_ID"
          
          # Get output
          aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "$INSTANCE_ID" --query "StandardOutputContent" --output text
