name: CD - Deploy Application

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options: [dev, prod]
      image_tag:
        type: string
        default: 'latest'
  push:
    branches: [main]
    paths: ['vote/**', 'result/**', 'worker/**', 'helm-chart/vote-app/**']

permissions:
  id-token: write
  contents: read

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    environment: dev
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.environment == 'dev')
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}
      - run: aws eks update-kubeconfig --name tactful-voting-dev --region ${{ vars.AWS_REGION }}
      - uses: azure/setup-helm@v4
      - id: tag
        run: echo "value=${{ github.event_name == 'workflow_dispatch' && inputs.image_tag || format('sha-{0}', github.sha) }}" >> $GITHUB_OUTPUT
      - run: |
          helm upgrade --install voting-app helm-chart/vote-app -n voting-dev --create-namespace \
            -f helm-chart/vote-app/values.yaml -f helm-chart/vote-app/values-dev.yaml \
            --set vote.image.tag=${{ steps.tag.outputs.value }} \
            --set result.image.tag=${{ steps.tag.outputs.value }} \
            --set worker.image.tag=${{ steps.tag.outputs.value }} \
            --wait --timeout 10m
      - run: kubectl wait --for=condition=available -n voting-dev deployment/vote deployment/result deployment/worker --timeout=5m

  deploy-prod:
    runs-on: ubuntu-latest
    environment: prod
    if: github.event_name == 'workflow_dispatch' && inputs.environment == 'prod'
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      # Prod: Deploy via SSM
      - run: |
          INSTANCE_ID=${{ secrets.PROD_SSM_INSTANCE_ID }}
          
          # Upload Helm chart to S3
          aws s3 cp helm-chart/vote-app/ s3://tactful-voting-artifacts-${{ vars.AWS_REGION }}/helm-chart/vote-app/ --recursive
          
          # Execute deployment via SSM
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters commands="[
              'aws eks update-kubeconfig --name tactful-voting-prod --region ${{ vars.AWS_REGION }}',
              'aws s3 cp s3://tactful-voting-artifacts-${{ vars.AWS_REGION }}/helm-chart/vote-app/ /tmp/vote-app/ --recursive',
              'helm upgrade --install voting-app /tmp/vote-app -n voting-prod --create-namespace -f /tmp/vote-app/values.yaml -f /tmp/vote-app/values-prod.yaml --set vote.image.tag=${{ inputs.image_tag }} --set result.image.tag=${{ inputs.image_tag }} --set worker.image.tag=${{ inputs.image_tag }} --wait --timeout 15m',
              'kubectl wait --for=condition=available -n voting-prod deployment/vote deployment/result deployment/worker --timeout=10m || helm rollback voting-app -n voting-prod'
            ]" \
            --output text --query "Command.CommandId")
          
          # Wait and get output
          aws ssm wait command-executed --command-id "$COMMAND_ID" --instance-id "$INSTANCE_ID"
          aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "$INSTANCE_ID" --query "StandardOutputContent" --output text
          
          # Check if command succeeded
          STATUS=$(aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "$INSTANCE_ID" --query "Status" --output text)
          if [ "$STATUS" != "Success" ]; then
            echo "‚ùå Deployment failed"
            exit 1
          fi

  smoke-dev:
    needs: deploy-dev
    if: needs.deploy-dev.result == 'success'
    uses: ./.github/workflows/smoke-tests.yaml
    secrets: inherit
    with:
      environment: dev

  smoke-prod:
    needs: deploy-prod
    if: needs.deploy-prod.result == 'success'
    uses: ./.github/workflows/smoke-tests.yaml
    secrets: inherit
    with:
      environment: prod
