# Default values for vote-app
# This file provides base configuration that can be overridden by values-dev.yaml or values-prod.yaml

# Global configuration shared across all services
global:
  namespace: voting
  imageRegistry: ibrahim1025
  imagePullPolicy: IfNotPresent


# Vote service configuration
vote:
  enabled: true
  replicaCount: 1
  
  image:
    repository: vote
    tag: latest
  
  service:
    type: ClusterIP
    port: 80
    targetPort: 80
  
  config:
    redisHost: redis-master
    redisPort: "6379"
    optionA: "Cats"
    optionB: "Dogs"
  
  resources:
    requests:
      memory: 128Mi
      cpu: 100m
    limits:
      memory: 256Mi
      cpu: 200m
  
  livenessProbe:
    httpGet:
      path: /
      port: 80
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  readinessProbe:
    httpGet:
      path: /
      port: 80
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
  
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
  
  autoscaling:
    enabled: false
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 80
    targetMemoryUtilizationPercentage: 80
  strategy:
    maxUnavailable: 0
    maxSurge: 1
  
  topologySpread:
    maxSkew: 1
    whenUnsatisfiable: ScheduleAnyway

  ingress:
    enabled: true
    className: alb
    annotations:
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}]'
      alb.ingress.kubernetes.io/healthcheck-path: /
      alb.ingress.kubernetes.io/tags: Service=vote,App=voting
    host: ""
    path: /
    pathType: Prefix

# Result service configuration
result:
  enabled: true
  replicaCount: 1
  
  image:
    repository: result
    tag: latest
  
  service:
    type: ClusterIP
    port: 8081
    targetPort: 8081
  
  config:
    port: "8081"
    postgresHost: postgresql
    postgresPort: "5432"
  
  resources:
    requests:
      memory: 128Mi
      cpu: 100m
    limits:
      memory: 256Mi
      cpu: 200m
  
  livenessProbe:
    httpGet:
      path: /
      port: 8081
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  readinessProbe:
    httpGet:
      path: /
      port: 8081
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
  
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
  
  autoscaling:
    enabled: false
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 80
    targetMemoryUtilizationPercentage: 80
  
  strategy:
    maxUnavailable: 0
    maxSurge: 1
  
  topologySpread:
    maxSkew: 1
    whenUnsatisfiable: ScheduleAnyway
  
  ingress:
    enabled: true
    className: alb
    annotations:
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}]'
      alb.ingress.kubernetes.io/healthcheck-path: /
      alb.ingress.kubernetes.io/tags: Service=result,App=voting
    host: ""
    path: /
    pathType: Prefix

# Worker service configuration
worker:
  enabled: true
  replicaCount: 1
  
  image:
    repository: worker
    tag: latest
  
  config:
    redisHost: redis-master
    redisPort: "6379"
    postgresHost: postgresql
    postgresPort: "5432"
  
  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi
      cpu: 500m
  
  securityContext:
    runAsNonRoot: false
    runAsUser: 1000
    fsGroup: 1000
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
  
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 80
    targetMemoryUtilizationPercentage: 80
  
  strategy:
    maxUnavailable: 0
    maxSurge: 1
  
  topologySpread:
    maxSkew: 1
    whenUnsatisfiable: ScheduleAnyway

# PostgreSQL connection configuration
# Credentials will come from External Secrets
postgresql:
  host: postgresql
  port: 5432
  auth:
    username: postgres
    database: votes
    existingSecret: postgresql-credentials
    secretKeys:
      adminPasswordKey: password
      userPasswordKey: password

# Redis connection configuration
redis:
  host: redis-master
  port: 6379

# External Secrets configuration
externalSecrets:
  enabled: true
  secretStore:
    name: aws-secretsmanager
    kind: SecretStore
  refreshInterval: 1h
  
  # AWS Secrets Manager secret name (will be set to match Terraform output)
  # Format: tactful-voting-{env}-postgresql-{random}
  # The secret only contains the password - other connection params are in deployment env vars
  postgresql:
    remoteSecretName: ""  # Must be provided via values-dev.yaml or values-prod.yaml

# Network Policies
networkPolicies:
  enabled: true

# Service Account
serviceAccount:
  create: true
  annotations: {}
  name: ""
