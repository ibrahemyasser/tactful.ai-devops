# Default values for vote-app
# This file provides base configuration that can be overridden by values-dev.yaml or values-prod.yaml

# Global configuration shared across all services
global:
  namespace: voting
  imageRegistry: ibrahim1025
  imagePullPolicy: IfNotPresent

# Shared Ingress for both vote and result services
ingress:
  enabled: true
  className: alb
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}]'
    alb.ingress.kubernetes.io/healthcheck-protocol: HTTP
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: "15"
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "5"
    alb.ingress.kubernetes.io/healthy-threshold-count: "2"
    alb.ingress.kubernetes.io/unhealthy-threshold-count: "2"
  # Path-based routing
  paths:
    vote:
      path: /vote
      pathType: Prefix
      serviceName: vote
      servicePort: 80
      healthCheckPath: /
    result:
      path: /result
      pathType: Prefix
      serviceName: result
      servicePort: 8081
      healthCheckPath: /

# Vote service configuration
vote:
  enabled: true
  replicaCount: 1
  
  image:
    repository: vote
    tag: latest
  
  service:
    type: ClusterIP
    port: 80
    targetPort: 80
  
  config:
    redisHost: redis-master
    redisPort: "6379"
    optionA: "Cats"
    optionB: "Dogs"
  
  resources:
    requests:
      memory: 128Mi
      cpu: 100m
    limits:
      memory: 256Mi
      cpu: 200m
  
  livenessProbe:
    httpGet:
      path: /
      port: 80
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  readinessProbe:
    httpGet:
      path: /
      port: 80
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
  
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false

# Result service configuration
result:
  enabled: true
  replicaCount: 1
  
  image:
    repository: result
    tag: latest
  
  service:
    type: ClusterIP
    port: 8081
    targetPort: 8081
  
  config:
    port: "8081"
    postgresHost: postgresql
    postgresPort: "5432"
  
  resources:
    requests:
      memory: 128Mi
      cpu: 100m
    limits:
      memory: 256Mi
      cpu: 200m
  
  livenessProbe:
    httpGet:
      path: /
      port: 8081
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  readinessProbe:
    httpGet:
      path: /
      port: 8081
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
  
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false

# Worker service configuration
worker:
  enabled: true
  replicaCount: 1
  
  image:
    repository: worker
    tag: latest
  
  config:
    redisHost: redis-master
    redisPort: "6379"
    postgresHost: postgresql
    postgresPort: "5432"
  
  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi
      cpu: 500m
  
  securityContext:
    runAsNonRoot: false
    runAsUser: 1000
    fsGroup: 1000
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false

# PostgreSQL connection configuration
# Credentials will come from External Secrets
postgresql:
  host: postgresql
  port: 5432
  auth:
    username: postgres
    database: votes
    existingSecret: postgresql-credentials
    secretKeys:
      adminPasswordKey: password
      userPasswordKey: password

# Redis connection configuration
redis:
  host: redis-master
  port: 6379

# External Secrets configuration
externalSecrets:
  enabled: true
  secretStore:
    name: aws-secretsmanager
    kind: SecretStore
  refreshInterval: 1h
  
  # AWS Secrets Manager secret name (will be set to match Terraform output)
  # Format: tactful-voting-{env}-postgresql-{random}
  # The secret only contains the password - other connection params are in deployment env vars
  postgresql:
    remoteSecretName: ""  # Must be provided via values-dev.yaml or values-prod.yaml

# Network Policies
networkPolicies:
  enabled: true

# Service Account
serviceAccount:
  create: true
  annotations: {}
  name: ""
